<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>æœ€çµ‚æŠ•ç¨¿ï¼ˆä¸‹æ›¸ãè‡ªå‹•ç”Ÿæˆï¼‰ - Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="min-h-screen bg-[#EEF3FF] text-slate-900">
    <!-- auth guard (prototype) -->
    <script>
      if (localStorage.getItem("aas_logged_in") !== "1") {
        window.location.href = "./login.html";
      }
    </script>

    <!-- Header -->
    <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-200">
      <div class="mx-auto max-w-[1200px] px-6 py-5 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-blue-50 border border-blue-200 flex items-center justify-center">
            <svg viewBox="0 0 24 24" class="h-5 w-5 text-blue-700" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 2 11 13" />
              <path d="M22 2 15 22l-4-9-9-4 20-7Z" />
            </svg>
          </div>
          <div>
            <div class="text-2xl font-extrabold tracking-tight">æœ€çµ‚æŠ•ç¨¿</div>
            <div class="text-sm text-slate-500">ãƒ’ã‚¢ãƒªãƒ³ã‚°å†…å®¹ã‹ã‚‰ä¸‹æ›¸ãã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button
            class="rounded-xl border border-slate-200 bg-white px-4 py-3 font-bold text-slate-700 hover:bg-slate-50"
            type="button"
            onclick="history.back()"
          >
            â† æˆ»ã‚‹
          </button>

          <a
            href="./results.html"
            class="rounded-xl bg-slate-700 px-4 py-3 text-white font-bold hover:bg-slate-800"
          >
            å—é¨“çµæœã¸
          </a>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-[1200px] px-6 py-8 space-y-6">
      <!-- Step bar -->
      <section class="rounded-2xl bg-white border border-slate-200 shadow-sm overflow-hidden">
        <div class="p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="flex items-center gap-3">
            <div class="h-8 w-8 rounded-full bg-blue-600 text-white font-extrabold flex items-center justify-center">1</div>
            <div class="font-extrabold">ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒ­ã‚°ã‚’ç”¨æ„</div>
            <div class="text-slate-400">â†’</div>
            <div class="h-8 w-8 rounded-full bg-blue-600 text-white font-extrabold flex items-center justify-center">2</div>
            <div class="font-extrabold">ä¸‹æ›¸ãç”Ÿæˆ</div>
            <div class="text-slate-400">â†’</div>
            <div class="h-8 w-8 rounded-full bg-blue-600 text-white font-extrabold flex items-center justify-center">3</div>
            <div class="font-extrabold">ç·¨é›†ã—ã¦æå‡º</div>
          </div>

          <div class="text-sm text-slate-500">
            ã‚±ãƒ¼ã‚¹ï¼š
            <span id="caseLabel" class="font-bold text-slate-700">â€”</span>
          </div>
        </div>
      </section>

      <!-- Hearing log -->
      <section class="rounded-2xl bg-white border border-slate-200 shadow-sm overflow-hidden">
        <div class="p-8">
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
            <div>
              <h2 class="text-xl font-extrabold">ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒ­ã‚°</h2>
              <p class="mt-2 text-slate-600 text-sm">
                ã“ã“ã«ãƒ’ã‚¢ãƒªãƒ³ã‚°ã®ã‚„ã‚Šå–ã‚Šï¼ˆç®‡æ¡æ›¸ãã§ã‚‚OKï¼‰ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br />
                â€»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã§ã¯ <b>ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆlocalStorageï¼‰</b> ã‹ã‚‰èª­ã¿è¾¼ã‚€ã“ã¨ã‚‚ã§ãã¾ã™ã€‚
              </p>
            </div>

            <div class="flex flex-wrap items-center gap-2">
              <button
                class="rounded-xl border border-slate-200 bg-white px-4 py-2 font-bold text-slate-700 hover:bg-slate-50"
                type="button"
                onclick="loadFromStorage()"
              >
                ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿
              </button>

              <button
                class="rounded-xl border border-slate-200 bg-white px-4 py-2 font-bold text-slate-700 hover:bg-slate-50"
                type="button"
                onclick="insertDemoLog()"
              >
                ãƒ‡ãƒ¢ãƒ­ã‚°æŒ¿å…¥
              </button>

              <button
                class="rounded-xl bg-blue-600 px-4 py-2 text-white font-extrabold hover:bg-blue-700"
                type="button"
                onclick="generateDraft()"
              >
                ä¸‹æ›¸ãç”Ÿæˆ
              </button>
            </div>
          </div>

          <div class="mt-5">
            <textarea
              id="logText"
              class="w-full min-h-[220px] rounded-2xl border border-slate-200 bg-white p-5 outline-none focus:ring-2 focus:ring-blue-100"
              placeholder="ä¾‹ï¼š\nãƒ»èª²é•·ï¼šAIå°å…¥ã®ç›®çš„ã¯ã€å±äººæ€§ã‚’æ¸›ã‚‰ã—å–ã‚Šã“ã¼ã—ã‚’æŠ‘ãˆãŸã„\nãƒ»ç¾çŠ¶ï¼šãƒ™ãƒ†ãƒ©ãƒ³ã¯çµŒé¨“å‰‡ã€è‹¥æ‰‹ã¯æ®‹é«˜é‡è¦–ã§ãƒ–ãƒ¬ã‚‹\nãƒ»äºˆæ¸¬ï¼šæ¥æœˆã®ç›¸è«‡ç¢ºåº¦ï¼ˆè³¼å…¥/å£²å´/ä¹—æ›ï¼‰ã‚’å‡ºã—ãŸã„\nãƒ»ç²¾åº¦ï¼šç©ºæŒ¯ã‚Šã‚’æ¸›ã‚‰ã—ãŸã„ãŒå–ã‚Šã“ã¼ã—ã‚‚æ€–ã„\nãƒ»PoCï¼šã¾ãš2æ”¯åº—ã€3ãƒ¶æœˆã§æ¤œè¨¼ã—ãŸã„"
              maxlength="8000"
            ></textarea>

            <div class="mt-2 flex items-center justify-between text-xs text-slate-500">
              <div>ä¿å­˜ã‚­ãƒ¼ï¼š<span class="font-bold">aas_hearing_log</span>ï¼ˆä»»æ„ï¼‰</div>
              <div><span id="logCount">0</span> / 8000</div>
            </div>

            <div class="mt-3 flex items-center gap-2">
              <button
                class="rounded-xl border border-slate-200 bg-white px-4 py-2 font-bold text-slate-700 hover:bg-slate-50"
                type="button"
                onclick="saveToStorage()"
              >
                ã“ã®ãƒ­ã‚°ã‚’ä¿å­˜
              </button>

              <div id="logStatus" class="text-sm text-slate-500"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Key points -->
      <section class="rounded-2xl bg-white border border-slate-200 shadow-sm overflow-hidden">
        <div class="p-8">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h2 class="text-xl font-extrabold">æŠ½å‡ºã•ã‚ŒãŸè¦ç‚¹ï¼ˆè‡ªå‹•ï¼‰</h2>
              <p class="mt-2 text-slate-600 text-sm">
                ä¸‹æ›¸ãç”Ÿæˆã®æ ¹æ‹ ã«ãªã‚‹è¦ç‚¹ã§ã™ã€‚ã†ã¾ãå–ã‚Œã¦ã„ãªã„å ´åˆã¯ãƒ­ã‚°ã‚’è¿½è¨˜ã—ã¦å†ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
              </p>
            </div>

            <button
              class="rounded-xl border border-slate-200 bg-white px-4 py-2 font-bold text-slate-700 hover:bg-slate-50"
              type="button"
              onclick="generateDraft()"
            >
              å†ç”Ÿæˆ
            </button>
          </div>

          <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4" id="pointsGrid">
            <!-- filled by JS -->
          </div>
        </div>
      </section>

      <!-- Final draft -->
      <section class="rounded-2xl bg-white border border-slate-200 shadow-sm overflow-hidden">
        <div class="p-8">
          <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
            <div>
              <h2 class="text-xl font-extrabold">æœ€çµ‚ææ¡ˆï¼ˆä¸‹æ›¸ãâ†’ç·¨é›†ã—ã¦æå‡ºï¼‰</h2>
              <p class="mt-2 text-slate-600 text-sm">
                ã€Œä¸‹æ›¸ãç”Ÿæˆã€ã§ä½œã‚‰ã‚ŒãŸæ–‡ç« ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€å¿…è¦ã«å¿œã˜ã¦è¿½è¨˜ãƒ»ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚
              </p>
            </div>

            <div class="flex flex-wrap items-center gap-2">
              <button
                class="rounded-xl border border-slate-200 bg-white px-4 py-2 font-bold text-slate-700 hover:bg-slate-50"
                type="button"
                onclick="insertTemplateOnly()"
              >
                ãƒ†ãƒ³ãƒ—ãƒ¬ã ã‘æŒ¿å…¥
              </button>

              <button
                class="rounded-xl border border-slate-200 bg-white px-4 py-2 font-bold text-slate-700 hover:bg-slate-50"
                type="button"
                onclick="copyDraft()"
              >
                ã‚³ãƒ”ãƒ¼
              </button>

              <button
                id="submitBtn"
                class="rounded-xl bg-slate-300 px-5 py-3 text-white font-extrabold cursor-not-allowed"
                type="button"
                disabled
                onclick="submitFinal()"
              >
                æå‡ºã™ã‚‹
              </button>
            </div>
          </div>

          <div class="mt-5 relative">
            <textarea
              id="finalText"
              class="w-full min-h-[420px] rounded-2xl border border-slate-200 bg-white p-5 pr-24 outline-none focus:ring-2 focus:ring-blue-100"
              placeholder="ä¸‹æ›¸ãç”Ÿæˆã‚’æŠ¼ã™ã¨ã€ã“ã“ã«æ–‡ç« ãŒå…¥ã‚Šã¾ã™ã€‚"
              maxlength="6000"
            ></textarea>
            <div class="absolute right-5 bottom-4 text-sm text-slate-400 font-semibold">
              <span id="finalCount">0</span> / 6000
            </div>
          </div>

          <div class="mt-4 rounded-2xl border border-amber-200 bg-amber-50 p-4 text-sm text-amber-800">
            <div class="font-extrabold">ãƒã‚§ãƒƒã‚¯ï¼ˆæ›¸ãæ¼ã‚Œé˜²æ­¢ï¼‰</div>
            <ul class="mt-2 list-disc pl-5 space-y-1" id="checkList">
              <!-- filled by JS -->
            </ul>
          </div>

          <p class="mt-4 text-sm text-slate-500 text-center">
            â€»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã®ãŸã‚æå‡ºã¯ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆlocalStorageï¼‰ã§æ“¬ä¼¼çš„ã«è¡Œã„ã¾ã™ã€‚
          </p>
        </div>
      </section>
    </main>

    <script>
      // -----------------------------
      // Basic setup
      // -----------------------------
      const logText = document.getElementById("logText");
      const logCount = document.getElementById("logCount");
      const logStatus = document.getElementById("logStatus");

      const finalText = document.getElementById("finalText");
      const finalCount = document.getElementById("finalCount");
      const submitBtn = document.getElementById("submitBtn");

      const pointsGrid = document.getElementById("pointsGrid");
      const checkList = document.getElementById("checkList");
      const caseLabel = document.getElementById("caseLabel");

      const STORAGE_LOG_KEY = "aas_hearing_log";
      const STORAGE_RESULTS_KEY = "aas_results";

      const url = new URL(window.location.href);
      const caseParam = url.searchParams.get("case") || "3";
      caseLabel.textContent = `ã‚±ãƒ¼ã‚¹${caseParam}`;

      function updateCounters() {
        logCount.textContent = String(logText.value.length);
        finalCount.textContent = String(finalText.value.length);

        const ok = finalText.value.trim().length > 0;
        submitBtn.disabled = !ok;
        submitBtn.className =
          "rounded-xl px-5 py-3 font-extrabold " +
          (ok
            ? "bg-blue-600 hover:bg-blue-700 text-white"
            : "bg-slate-300 text-white cursor-not-allowed");
      }

      logText.addEventListener("input", updateCounters);
      finalText.addEventListener("input", () => {
        updateCounters();
        renderChecklist(finalText.value);
      });
      updateCounters();

      // -----------------------------
      // Storage helpers
      // -----------------------------
      function loadFromStorage() {
        const v = localStorage.getItem(STORAGE_LOG_KEY);
        if (!v) {
          logStatus.textContent = "ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ‡ãƒ¢ãƒ­ã‚°æŒ¿å…¥ã‚‚ä½¿ãˆã¾ã™ï¼‰";
          return;
        }
        logText.value = v;
        logStatus.textContent = "ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ";
        updateCounters();
      }

      function saveToStorage() {
        const v = logText.value.trim();
        if (!v) {
          logStatus.textContent = "ç©ºã®ãŸã‚ä¿å­˜ã§ãã¾ã›ã‚“";
          return;
        }
        localStorage.setItem(STORAGE_LOG_KEY, v);
        logStatus.textContent = "ã“ã®ãƒ­ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆaas_hearing_logï¼‰";
      }

      function insertDemoLog() {
        logText.value =
`ã€ç™»å ´äººç‰©ã€‘å€‹äººå–¶æ¥­éƒ¨èª²é•·ï¼ãƒ™ãƒ†ãƒ©ãƒ³è²©å£²å“¡Aï¼ãƒ™ãƒ†ãƒ©ãƒ³è²©å£²å“¡B

ãƒ»èª²é•·ï¼šAIå°å…¥ã®ç›®çš„ã¯ã€å–¶æ¥­ã‚¿ãƒ¼ã‚²ãƒƒãƒˆé¸å®šã®å±äººæ€§ã‚’æ¸›ã‚‰ã—ã€å–ã‚Šã“ã¼ã—ã‚’æŠ‘ãˆã‚‹ã“ã¨
ãƒ»ç¾çŠ¶ï¼šãƒ™ãƒ†ãƒ©ãƒ³ã¯ãƒœãƒ¼ãƒŠã‚¹æœŸã«å‹•ãã‚„ã™ã„äººãƒ»ä¹—æ›ææ¡ˆã«å¿œã˜ã‚„ã™ã„äººã‚’ä¸Šä½ã«ã™ã‚‹
ãƒ»ç¾çŠ¶ï¼šè‹¥æ‰‹ã¯æ®‹é«˜ãŒå¤§ãã„äººãƒ»è³¼å…¥ã‹ã‚‰æ™‚é–“ãŒçµŒã£ã¦ã„ã‚‹äººãªã©æ•°å­—ãƒ™ãƒ¼ã‚¹ã§å„ªå…ˆåº¦ã‚’ä»˜ã‘ãŒã¡
ãƒ»èª²é¡Œï¼šåˆ¤æ–­ã®ãƒ–ãƒ¬ãŒå¤§ããã€ç©ºæŒ¯ã‚Šã‚‚å¤šã„ã€‚å–ã‚Šã“ã¼ã—ã‚‚èµ·ãã¦ã„ã‚‹ã¯ãš
ãƒ»äºˆæ¸¬ï¼šæ¥æœˆã€œç¿Œã€…æœˆã®ã€Œç›¸è«‡ç¢ºåº¦ï¼ˆè³¼å…¥/å£²å´/ä¹—æ›ï¼‰ã€ã‚’ç¢ºç‡ã§å‡ºã—ãŸã„
ãƒ»é‹ç”¨ï¼šç¢ºç‡ä¸Šä½Nä»¶ã‚’è¨ªå•å€™è£œã¨ã—ã¦æç¤ºã—ã€æ”¯åº—ã§ãƒ•ã‚©ãƒ­ãƒ¼
ãƒ»ç²¾åº¦ï¼šç©ºæŒ¯ã‚Šã‚’æ¸›ã‚‰ã—ãŸã„ãŒã€å–ã‚Šã“ã¼ã—ã‚’å¢—ã‚„ã—ã™ããªã„ã“ã¨ã‚‚é‡è¦
ãƒ»PoCï¼šã¾ãš2æ”¯åº—ã§3ãƒ¶æœˆã€‚ç¾å ´ã®å—å®¹æ€§ï¼ˆèª¬æ˜å¯èƒ½æ€§ï¼‰ã‚‚è©•ä¾¡ã—ãŸã„
ãƒ»æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼šæˆåŠŸæ¡ä»¶ã®åˆæ„â†’ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºâ†’æ¤œè¨¼è¨­è¨ˆï¼ˆãƒªãƒ¼ã‚¯å¯¾ç­–ï¼‰`;
        logStatus.textContent = "ãƒ‡ãƒ¢ãƒ­ã‚°ã‚’æŒ¿å…¥ã—ã¾ã—ãŸã€‚ä¸‹æ›¸ãç”Ÿæˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
        updateCounters();
      }

      // expose for inline
      window.loadFromStorage = loadFromStorage;
      window.saveToStorage = saveToStorage;
      window.insertDemoLog = insertDemoLog;

      // -----------------------------
      // Draft generation (rule-based)
      // â€»ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼šAIã§ã¯ãªãã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼‹ãƒ†ãƒ³ãƒ—ãƒ¬åŸ‹ã‚ã§ã€Œãã‚Œã£ã½ã„ã€ä¸‹æ›¸ãã‚’ä½œã‚‹
      // -----------------------------
      const TOPIC = {
        purpose: ["ç›®çš„", "ã‚´ãƒ¼ãƒ«", "ç‹™ã„", "ã—ãŸã„", "ã­ã‚‰ã„"],
        current: ["ç¾çŠ¶", "ã„ã¾", "ç¾åœ¨", "ä»Šã¯"],
        issue: ["èª²é¡Œ", "å•é¡Œ", "è©°ã¾", "å±äºº", "ãƒ–ãƒ¬", "ç©ºæŒ¯", "å–ã‚Šã“ã¼"],
        target: ["äºˆæ¸¬", "å¯¾è±¡", "èª°ã‚’", "ã„ã¤", "ç¿Œæœˆ", "ç¿Œã€…æœˆ", "ç¢ºåº¦", "è³¼å…¥", "å£²å´", "ä¹—æ›", "æ¥åº—", "ç›¸è«‡"],
        accuracy: ["ç²¾åº¦", "é–¾å€¤", "ç©ºæŒ¯ã‚Š", "å–ã‚Šã“ã¼ã—", "ç¢ºç‡", "ä¸Šä½", "Nä»¶"],
        poc: ["PoC", "æ¤œè¨¼", "ç¯„å›²", "æœŸé–“", "æ”¯åº—", "ãƒ‡ãƒ¼ã‚¿", "ãƒªãƒ¼ã‚¯", "è©•ä¾¡", "æˆåŠŸæ¡ä»¶", "KPI"],
        next: ["æ¬¡", "ã‚¢ã‚¯ã‚·ãƒ§ãƒ³", "æ‹…å½“", "æœŸé™", "åˆæ„", "ãƒ‡ãƒ¼ã‚¿æŠ½å‡º", "è¨­è¨ˆ"]
      };

      function pickLines(text, keywords, limit = 3) {
        const lines = text.split(/\n+/).map(s => s.trim()).filter(Boolean);
        const hits = [];
        for (const ln of lines) {
          if (keywords.some(k => ln.includes(k))) hits.push(ln);
          if (hits.length >= limit) break;
        }
        return hits;
      }

      function fallbackIfEmpty(arr, fallback) {
        return arr.length ? arr : [fallback];
      }

      function buildPoints(log) {
        const p = fallbackIfEmpty(
          pickLines(log, TOPIC.purpose, 3),
          "ï¼ˆç›®çš„ãŒæœªæŠ½å‡ºï¼‰ä¾‹ï¼šå±äººæ€§ã‚’æ¸›ã‚‰ã—ã€å–ã‚Šã“ã¼ã—ã‚’æŠ‘ãˆã‚‹"
        );
        const cur = fallbackIfEmpty(
          pickLines(log, TOPIC.current.concat(["ãƒ™ãƒ†ãƒ©ãƒ³", "è‹¥æ‰‹"]), 3),
          "ï¼ˆç¾çŠ¶ãŒæœªæŠ½å‡ºï¼‰ä¾‹ï¼šçµŒé¨“å‰‡ã‚„æ®‹é«˜é‡è¦–ã§åˆ¤æ–­ãŒãƒ–ãƒ¬ã‚‹"
        );
        const iss = fallbackIfEmpty(
          pickLines(log, TOPIC.issue, 3),
          "ï¼ˆèª²é¡ŒãŒæœªæŠ½å‡ºï¼‰ä¾‹ï¼šç©ºæŒ¯ã‚Šãƒ»å–ã‚Šã“ã¼ã—ãƒ»å±äººæ€§"
        );
        const tgt = fallbackIfEmpty(
          pickLines(log, TOPIC.target, 3),
          "ï¼ˆäºˆæ¸¬å¯¾è±¡ãŒæœªæŠ½å‡ºï¼‰ä¾‹ï¼šæ¥æœˆã®ç›¸è«‡ç¢ºåº¦ï¼ˆè³¼å…¥/å£²å´/ä¹—æ›ï¼‰"
        );
        const acc = fallbackIfEmpty(
          pickLines(log, TOPIC.accuracy, 3),
          "ï¼ˆç²¾åº¦ç›®æ¨™ãŒæœªæŠ½å‡ºï¼‰ä¾‹ï¼šç©ºæŒ¯ã‚Šã‚’æ¸›ã‚‰ã—ã¤ã¤å–ã‚Šã“ã¼ã—ã‚‚æŠ‘ãˆã‚‹"
        );
        const poc = fallbackIfEmpty(
          pickLines(log, TOPIC.poc, 4),
          "ï¼ˆPoCãŒæœªæŠ½å‡ºï¼‰ä¾‹ï¼š2æ”¯åº—Ã—3ãƒ¶æœˆã€KPIã¯å–ã‚Šã“ã¼ã—/ç©ºæŒ¯ã‚Š/å—å®¹æ€§"
        );
        const nxt = fallbackIfEmpty(
          pickLines(log, TOPIC.next, 3),
          "ï¼ˆæ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæœªæŠ½å‡ºï¼‰ä¾‹ï¼šæˆåŠŸæ¡ä»¶åˆæ„â†’ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºâ†’æ¤œè¨¼è¨­è¨ˆ"
        );

        return { p, cur, iss, tgt, acc, poc, nxt };
      }

      function renderPoints(points) {
        const items = [
          { title: "ç›®çš„", icon: "ğŸ¯", list: points.p },
          { title: "ç¾çŠ¶", icon: "ğŸ§©", list: points.cur },
          { title: "èª²é¡Œ", icon: "âš ï¸", list: points.iss },
          { title: "äºˆæ¸¬å¯¾è±¡", icon: "ğŸ”", list: points.tgt },
          { title: "ç²¾åº¦ç›®æ¨™/é‹ç”¨", icon: "ğŸ“ˆ", list: points.acc },
          { title: "PoC/æ¤œè¨¼", icon: "ğŸ§ª", list: points.poc },
          { title: "æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³", icon: "âœ…", list: points.nxt },
        ];

        pointsGrid.innerHTML = items
          .map(it => `
            <div class="rounded-2xl border border-slate-200 bg-slate-50 p-5">
              <div class="flex items-center gap-2">
                <div class="text-lg">${it.icon}</div>
                <div class="font-extrabold">${it.title}</div>
              </div>
              <ul class="mt-3 list-disc pl-5 space-y-1 text-sm text-slate-800">
                ${it.list.map(x => `<li>${escapeHtml(x)}</li>`).join("")}
              </ul>
            </div>
          `)
          .join("");
      }

      function templateOnly(points) {
        return `ã€1. ç›®çš„ï¼ˆä»Šå›ã®ã‚´ãƒ¼ãƒ«ï¼‰ã€‘
- ï¼ˆã“ã“ã«ç›®çš„ã‚’ä¸€æ–‡ã§ï¼‰ 

ã€2. ç¾çŠ¶èª²é¡Œï¼ˆä½•ãŒè©°ã¾ã£ã¦ã„ã‚‹ã‹ï¼‰ã€‘
- ï¼ˆç¾çŠ¶ã®åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯ã¨èª²é¡Œã‚’ï¼‰ 

ã€3. ææ¡ˆï¼ˆä½•ã‚’ã©ã†å¤‰ãˆã‚‹ã‹ï¼‰ã€‘
- ï¼ˆAIã§ä½•ã‚’äºˆæ¸¬ã—ã€ã©ã“ã«çµ„ã¿è¾¼ã‚€ã‹ï¼‰ 

ã€4. æœŸå¾…åŠ¹æœï¼ˆKPI/å®šé‡ï¼‰ã€‘
- ï¼ˆå–ã‚Šã“ã¼ã—ç‡â†“ã€ç©ºæŒ¯ã‚Šâ†“ã€æˆç´„ç‡â†‘ã€æº–å‚™æ™‚é–“â†“ãªã©ï¼‰ 

ã€5. æ¤œè¨¼è¨ˆç”»ï¼ˆPoCç¯„å›²ãƒ»æœŸé–“ãƒ»è©•ä¾¡ï¼‰ã€‘
- ï¼ˆå¯¾è±¡æ”¯åº—ï¼æœŸé–“ï¼è©•ä¾¡æŒ‡æ¨™ï¼ãƒªãƒ¼ã‚¯å¯¾ç­–ï¼‰ 

ã€6. æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆèª°ãŒãƒ»ã„ã¤ã¾ã§ã«ï¼‰ã€‘
- ï¼ˆåˆæ„â†’ãƒ‡ãƒ¼ã‚¿â†’è¨­è¨ˆâ†’å®Ÿæ–½ã®é †ã§ï¼‰`;
      }

      function makeDraft(points) {
        // â€œãã‚Œã£ã½ã„â€æ–‡ç« ã®ä¸‹æ›¸ã
        const purpose = points.p.map(x => `- ${stripPrefix(x)}`).join("\n");
        const current = points.cur.map(x => `- ${stripPrefix(x)}`).join("\n");
        const issue = points.iss.map(x => `- ${stripPrefix(x)}`).join("\n");
        const target = points.tgt.map(x => `- ${stripPrefix(x)}`).join("\n");
        const accuracy = points.acc.map(x => `- ${stripPrefix(x)}`).join("\n");
        const poc = points.poc.map(x => `- ${stripPrefix(x)}`).join("\n");
        const next = points.nxt.map(x => `- ${stripPrefix(x)}`).join("\n");

        return `ã€1. ç›®çš„ï¼ˆä»Šå›ã®ã‚´ãƒ¼ãƒ«ï¼‰ã€‘
${purpose}

ã€2. ç¾çŠ¶èª²é¡Œï¼ˆä½•ãŒè©°ã¾ã£ã¦ã„ã‚‹ã‹ï¼‰ã€‘
ï¼ˆç¾çŠ¶ï¼‰
${current}

ï¼ˆèª²é¡Œï¼‰
${issue}

ã€3. ææ¡ˆï¼ˆä½•ã‚’ã©ã†å¤‰ãˆã‚‹ã‹ï¼‰ã€‘
- ä¸Šè¨˜ã®å±äººæ€§/åˆ¤æ–­ãƒ–ãƒ¬ã‚’æŠ‘ãˆã‚‹ãŸã‚ã€å–å¼•ãƒ»ææ¡ˆå±¥æ­´ãªã©ã‹ã‚‰ã€Œç›¸è«‡ç¢ºåº¦ã€ã‚’ç¢ºç‡ã§ç®—å‡ºã—ã€å–¶æ¥­ãŒä½¿ãˆã‚‹å½¢ã§æç¤ºã—ã¾ã™ã€‚
ï¼ˆäºˆæ¸¬å¯¾è±¡ï¼‰
${target}

ï¼ˆé‹ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰
- ç¢ºç‡ä¸Šä½Nä»¶ã‚’è¨ªå•å€™è£œã¨ã—ã¦æç¤ºã—ã€æ”¯åº—/æ‹…å½“è€…ãŒæœ€çµ‚åˆ¤æ–­ãƒ»ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¾ã™ã€‚

ã€4. æœŸå¾…åŠ¹æœï¼ˆKPI/å®šé‡ï¼‰ã€‘
- å–ã‚Šã“ã¼ã—ã®æŠ‘åˆ¶ï¼ˆæœ¬æ¥ç›¸è«‡ã«è‡³ã‚‹é¡§å®¢ã‚’æ‹¾ã†ï¼‰
- ç©ºæŒ¯ã‚Šå‰Šæ¸›ï¼ˆå„ªå…ˆåº¦ã®ä½ã„è¨ªå•ã‚’æ¸›ã‚‰ã™ï¼‰
- è¨ªå•æº–å‚™ã®æ™‚é–“å‰Šæ¸›ï¼ˆãƒªã‚¹ãƒˆä½œæˆã®åŠ¹ç‡åŒ–ï¼‰
â€»KPIã¯ã€Œå–ã‚Šã“ã¼ã—ç‡ã€ã€Œç©ºæŒ¯ã‚Šç‡ã€ã€Œæˆç´„ç‡ã€ã€Œç¾å ´ã®å—å®¹æ€§ï¼ˆèª¬æ˜å¯èƒ½æ€§ï¼‰ã€ãªã©ã§è©•ä¾¡ã—ã¾ã™ã€‚

ã€5. æ¤œè¨¼è¨ˆç”»ï¼ˆPoCç¯„å›²ãƒ»æœŸé–“ãƒ»è©•ä¾¡ï¼‰ã€‘
${poc}
- ãƒ‡ãƒ¼ã‚¿åˆ†å‰²ãƒ»ãƒªãƒ¼ã‚¯å¯¾ç­–ï¼ˆæœªæ¥æƒ…å ±ã®æ··å…¥é˜²æ­¢ï¼‰ã‚’è¨­è¨ˆã—ãŸä¸Šã§ã€PoCã®æˆåŠŸæ¡ä»¶ã‚’äº‹å‰ã«åˆæ„ã—ã¾ã™ã€‚

ã€6. æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆèª°ãŒãƒ»ã„ã¤ã¾ã§ã«ï¼‰ã€‘
${next}
- é–¢ä¿‚è€…ï¼ˆèª²é•·/ç¾å ´/ã‚·ã‚¹ãƒ†ãƒ éƒ¨ï¼‰ã¨ã€ç›®çš„ãƒ»ç²¾åº¦ç›®æ¨™ãƒ»PoCç¯„å›²ã‚’ç¢ºå®šã—ã¦ã‹ã‚‰å®Ÿè£…ã«å…¥ã‚Šã¾ã™ã€‚`;
      }

      function generateDraft() {
        const log = logText.value.trim();
        if (!log) {
          alert("ãƒ’ã‚¢ãƒªãƒ³ã‚°ãƒ­ã‚°ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ãƒ‡ãƒ¢ãƒ­ã‚°æŒ¿å…¥ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        const points = buildPoints(log);
        renderPoints(points);

        // draft to final textarea (overwrite, but safe: ask if not empty)
        const draft = makeDraft(points);
        if (finalText.value.trim().length > 0) {
          const ok = confirm("ã™ã§ã«æœ€çµ‚ææ¡ˆãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚ä¸‹æ›¸ãã§ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§è¿½è¨˜ã—ã¾ã™ï¼‰");
          if (ok) finalText.value = draft;
          else finalText.value = finalText.value.trim() + "\n\n" + draft;
        } else {
          finalText.value = draft;
        }

        updateCounters();
        renderChecklist(finalText.value);

        // scroll to final area
        finalText.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      window.generateDraft = generateDraft;

      function insertTemplateOnly() {
        const log = logText.value.trim();
        const points = log ? buildPoints(log) : null;
        const tpl = templateOnly(points);
        finalText.value = finalText.value.trim()
          ? finalText.value.trim() + "\n\n" + tpl
          : tpl;
        updateCounters();
        renderChecklist(finalText.value);
      }
      window.insertTemplateOnly = insertTemplateOnly;

      async function copyDraft() {
        const text = finalText.value.trim();
        if (!text) {
          alert("ã‚³ãƒ”ãƒ¼ã™ã‚‹å†…å®¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸‹æ›¸ãç”Ÿæˆã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        try {
          await navigator.clipboard.writeText(text);
          alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        } catch {
          finalText.select();
          alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ãŸãŸã‚ã€æ–‡ç« ã‚’é¸æŠçŠ¶æ…‹ã«ã—ã¾ã—ãŸï¼ˆCtrl+Cã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰");
        }
      }
      window.copyDraft = copyDraft;

      // -----------------------------
      // Checklist (simple keyword-based)
      // -----------------------------
      function renderChecklist(text) {
        const t = (text || "").toLowerCase();
        const checks = [
          { label: "ç›®çš„ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹", ok: t.includes("ç›®çš„") || t.includes("ã‚´ãƒ¼ãƒ«") },
          { label: "ç¾çŠ¶ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹", ok: t.includes("ç¾çŠ¶") },
          { label: "èª²é¡ŒãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹", ok: t.includes("èª²é¡Œ") || t.includes("å•é¡Œ") || t.includes("å±äºº") },
          { label: "äºˆæ¸¬å¯¾è±¡ï¼ˆèª°ã‚’/ã„ã¤/ä½•ã‚’ï¼‰ãŒã‚ã‚‹", ok: t.includes("äºˆæ¸¬") || t.includes("ç¢ºåº¦") || t.includes("ç¿Œæœˆ") || t.includes("ç¿Œã€…æœˆ") },
          { label: "PoC/æ¤œè¨¼ç¯„å›²ï¼ˆæœŸé–“/å¯¾è±¡/è©•ä¾¡ï¼‰ãŒã‚ã‚‹", ok: t.includes("poc") || t.includes("æ¤œè¨¼") || t.includes("æœŸé–“") || t.includes("æ”¯åº—") || t.includes("è©•ä¾¡") },
          { label: "æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹", ok: t.includes("æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³") || t.includes("æ‹…å½“") || t.includes("åˆæ„") },
        ];

        checkList.innerHTML = checks
          .map(c => `
            <li class="${c.ok ? "text-emerald-700" : "text-amber-800"}">
              <span class="font-bold">${c.ok ? "âœ“" : "â€¢"}</span> ${c.label}
            </li>
          `)
          .join("");
      }
      renderChecklist("");

      // -----------------------------
      // Submit (prototype): append to aas_results and go to result-detail
      // -----------------------------
      function makeId() {
        return Math.random().toString(36).slice(2, 10) + "-" + Date.now().toString(36);
      }

      function submitFinal() {
        const text = finalText.value.trim();
        if (!text) return;

        // load existing results
        let arr = [];
        try {
          arr = JSON.parse(localStorage.getItem(STORAGE_RESULTS_KEY) || "[]");
          if (!Array.isArray(arr)) arr = [];
        } catch {
          arr = [];
        }

        const now = new Date().toISOString();
        const id = makeId();

        // very rough rubric from checklist
        const t = text.toLowerCase();
        const scorePurpose = t.includes("ç›®çš„") ? 60 : 20;
        const scoreIssue = t.includes("èª²é¡Œ") ? 60 : 20;
        const scoreTarget = (t.includes("äºˆæ¸¬") || t.includes("ç¢ºåº¦")) ? 60 : 20;
        const scorePoc = (t.includes("poc") || t.includes("æ¤œè¨¼")) ? 60 : 20;

        const overall = Math.round((scorePurpose + scoreIssue + scoreTarget + scorePoc) / 4);

        const record = {
          id,
          scenario: `ãƒãƒŠãƒ“DX QUESTï¼ˆã‚±ãƒ¼ã‚¹${caseParam}ï¼‰`,
          case: `ã‚±ãƒ¼ã‚¹${caseParam}`,
          status: "æå‡ºæ¸ˆ",
          submittedAt: now,
          finalPost: text,
          overall,
          rubric: {
            "AIæ´»ç”¨ã®ç›®çš„": { score: scorePurpose, weight: 3 },
            "ç¾çŠ¶ãƒ»èª²é¡Œ": { score: scoreIssue, weight: 5 },
            "äºˆæ¸¬å¯¾è±¡": { score: scoreTarget, weight: 3 },
            "PoCã®æ¤œè¨¼ç›®çš„ãƒ»ç¯„å›²": { score: scorePoc, weight: 4 },
          },
        };

        arr.unshift(record);
        localStorage.setItem(STORAGE_RESULTS_KEY, JSON.stringify(arr));

        // go to detail
        window.location.href = `./result-detail.html?id=${encodeURIComponent(id)}&from=${encodeURIComponent("./submit3.html")}`;
      }
      window.submitFinal = submitFinal;

      // -----------------------------
      // Small helpers
      // -----------------------------
      function stripPrefix(s) {
        return s.replace(/^ãƒ»/g, "").trim();
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }
    </script>
  </body>
</html>
